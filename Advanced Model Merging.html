<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Guide: Advanced Model Merging (Triple Strategy)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
    <!-- Chosen Palette: Celestial Indigo -->
    <!-- Application Structure Plan: The application retains its core three-strategy structure, toggled by the user. A significant visual enhancement is a WebGL shader-based animated background, providing an immersive, high-tech feel appropriate for the AI topic. Key diagrams (like CLIP merging) are transformed from text-based lists into graphical flowcharts using styled HTML/CSS for better comprehension. A new 'Glossary' section is added to define complex terms, improving accessibility for a wider audience. This structure layers rich visuals and explanatory content over the robust interactive data core, enhancing user engagement and understanding. -->
    <!-- Visualization & Content Choices: Report Info -> Merging processes. Goal -> Visually explain data flow. Viz/Presentation -> HTML/CSS flowcharts with lines and arrows instead of simple lists. Interaction -> None, static display. Justification -> Flowcharts are intrinsically better at showing process and relationships than lists. Report Info -> DARE-TIES parameters. Goal -> Make abstract parameters tangible. Viz/Presentation -> Updated, more detailed instructional text and node diagrams instead of simple progress bars. Interaction -> N/A, informational. Justification -> Enhances the "Skill Injection" metaphor with real, actionable steps. New Content -> Glossary of Terms. Goal -> Define jargon. Viz/Presentation -> A dedicated, styled section. Interaction -> N/A. Justification -> Crucial for user education and making the complex topic approachable. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #cbd5e1; /* slate-300 */
        }
        #shader-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.4;
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        @media (min-width: 768px) {
           .chart-container {
                height: 450px;
            }
        }
        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            white-space: pre-wrap; /* Allow wrapping */
            word-wrap: break-word; /* Break long words */
            border: 1px solid #334155;
        }
        .version-btn,.recipe-btn {
            transition: background-color 0.3s, border-color 0.3s, color 0.3s, box-shadow 0.3s, transform 0.3s;
            transform-style: preserve-3d;
        }
        .card {
            background-color: rgba(15, 23, 42, 0.6); /* slate-900 with opacity */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        .card:hover {
            box-shadow: 0 0 25px -5px rgba(79, 70, 229, 0.3);
            border-color: #4f46e5; /* indigo-600 */
            transform: translateY(-4px) scale(1.02);
        }
        .version-btn, .recipe-btn {
            background-color: rgba(30, 41, 59, 0.8); /* slate-800 */
            color: #e2e8f0; /* slate-200 */
            border: 1px solid #475569; /* slate-600 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .version-btn:hover, .recipe-btn:hover {
             background-color: #3730a3; /* indigo-800 */
             border-color: #6366f1; /* indigo-500 */
             color: white;
        }
        .version-btn.active, .recipe-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
            border-color: #6366f1; /* indigo-500 */
        }
    </style>
</head>
<body class="bg-slate-900">
    <canvas id="shader-canvas"></canvas>
    <div class="content-wrapper">
        <header class="bg-slate-900/50 backdrop-blur-lg sticky top-0 z-50 border-b border-slate-700">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="font-bold text-lg text-slate-100">Chimera Merge Guide</span>
                    </div>
                    <div class="flex items-center space-x-4 text-sm font-medium">
                        <a id="nav-blueprints" href="#sdxl-blueprints" class="text-slate-300 hover:text-white transition-colors">Blueprints</a>
                        <a id="nav-recipes" href="#sdxl-recipes" class="text-slate-300 hover:text-white transition-colors">Recipes</a>
                        <a href="#analysis" class="text-slate-300 hover:text-white transition-colors">Analysis</a>
                        <a href="#glossary" class="text-slate-300 hover:text-white transition-colors">Glossary</a>
                    </div>
                </div>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <section class="text-center mb-16">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-100 tracking-tight">Advanced Model Merging</h1>
                <p class="mt-4 text-lg text-slate-400 max-w-3xl mx-auto">A consolidated, interactive guide to three distinct merging philosophies. Select a version below to explore its unique strategy, components, and recipes.</p>
            </section>

            <div class="flex justify-center flex-wrap gap-4 mb-16 p-4 bg-slate-800/50 border border-slate-700 rounded-lg shadow-inner">
                <button id="select-sdxl" class="version-btn active px-6 py-3 rounded-md text-base font-medium">"SDXL Donor" Version</button>
                <button id="select-pony" class="version-btn px-6 py-3 rounded-md text-base font-medium">"PONY Family" Version</button>
                <button id="select-hybrid" class="version-btn px-6 py-3 rounded-md text-base font-medium">"PONY + SDXL Hybrid" Version</button>
            </div>

            <div id="sdxl-content">
                <section id="sdxl-blueprints" class="mb-24 scroll-mt-20">
                    <h2 class="text-3xl font-bold text-slate-100 mb-2">Blueprint: SDXL Donor Strategy</h2>
                    <p class="text-slate-400 mb-10 max-w-4xl">This strategy uses a stable anime host model and surgically injects specific "skills" (like style or thematic content) from architecturally different `SDXL 1.0` donors using the DARE-TIES algorithm. This is akin to transplanting an organ, requiring precision to ensure compatibility.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1353314?modelVersionId=1984137" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">Animij [Illustrious] V5.0</h3></a><p class="text-sm font-medium text-indigo-400 mb-2">Primary Host Model</p><p class="text-sm text-slate-400 flex-grow">Provides the foundational scaffold: superior anatomy, composition, and a vibrant retro anime style.</p></div>
                        <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1721372?modelVersionId=1948027" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">Graycolor SemiRealIllustMix</h3></a><p class="text-sm font-medium text-indigo-400 mb-2">Secondary Host Model</p><p class="text-sm text-slate-400 flex-grow">Acts as a bridge, blending the pure anime look with a semi-realistic feel to make the host more receptive to donors.</p></div>
                        <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/163139?modelVersionId=481390" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">Boomer Art Model v2.0</h3></a><p class="text-sm font-medium text-amber-400 mb-2">Primary Style Donor</p><p class="text-sm text-slate-400 flex-grow">Injects the painterly, heroic fantasy essence of Frazetta and Vallejo, providing the desired textural finish.</p></div>
                        <div class="card p-6 flex flex-col ring-2 ring-red-500/50"><a href="https://civitai.com/models/1655833/d34dch4nn3lsdxl?modelVersionId=1874216" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">D34D.CH4NN3L.SDXL</h3></a><p class="text-sm font-medium text-red-400 mb-2">Thematic Donor</p><p class="text-sm text-slate-400 flex-grow">A powerful and versatile donor for injecting dark, gritty, horror, and sci-fi thematic content.</p></div>
                    </div>
                </section>
                <section id="sdxl-recipes" class="mb-24 scroll-mt-20">
                    <h2 class="text-3xl font-bold text-slate-100 mb-2">Recipe & Implementation: SDXL Donor</h2>
                    <div class="card p-6 md:p-8 mb-12">
                        <h3 class="text-xl font-bold text-slate-100 mb-4">Stage 1: Host Creation (Block-Weighted Merge)</h3>
                        <p class="text-sm text-slate-400 mb-6">First, we create a robust host model by merging our two base models. Select one of the three alternative recipes below. Each offers a different strategic trade-off between structural coherence and stylistic flexibility.</p>
                        <div class="flex justify-center flex-wrap gap-4 mb-6">
                            <button id="recipe-sdxl-balanced" class="recipe-btn active px-4 py-2 rounded-md text-sm font-medium">Recipe A: Balanced (Default)</button>
                            <button id="recipe-sdxl-host_dominant" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Recipe B: Host-Dominant</button>
                            <button id="recipe-sdxl-donor_receptive" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Recipe C: Donor-Receptive</button>
                        </div>
                        <div id="sdxl-recipe-explanation" class="mb-6 p-4 bg-indigo-900/30 border border-indigo-500/50 text-indigo-200 rounded-md text-sm"></div>
                        <div class="chart-container"><canvas id="sdxlChart"></canvas></div>
                        <div id="sdxl-justification" class="mt-6 p-4 bg-slate-800 rounded-md text-sm text-slate-400 min-h-[60px]">Hover over a block in the chart to see the justification for its weighting.</div>
                    </div>
                    <div class="card p-6 md:p-8 mb-12">
                         <h3 class="text-xl font-bold text-slate-100 mb-4">Stage 2: Skill Injection (DARE-TIES)</h3>
                         <p class="text-sm text-slate-400 mb-6">The two `SDXL 1.0` donors are injected sequentially into the host created in Stage 1. This requires the `ComfyUI-DareMerge` custom nodes. The key is to correctly calculate the 'task vector'—the difference between the donor and its own base model—and then apply it surgically to our host.</p>
                         <div class="grid md:grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 border border-slate-700 rounded-lg bg-slate-900/50">
                                <h4 class="font-bold text-lg text-slate-200 mb-4">Step 2a: Inject Painterly Style (`Boomer Art`)</h4>
                                <p class="text-sm text-slate-400 mb-4">This step infuses the host with a painterly texture. The settings aim for a noticeable but not overwhelming stylistic shift.</p>
                                <div class="code-block">
<strong class="text-amber-300">Node Setup:</strong> `TIES Merge (DARE)`
<strong>model_a (Host):</strong> <em>Host from Stage 1</em>
<strong>model_b (Donor):</strong> Boomer Art Model
<strong>base_model_a:</strong> kohaku-xl-beta5.safetensors
<strong>base_model_b:</strong> sd_xl_base_1.0.safetensors
<strong>dare_setup -></strong> (Connect `DARE Setup` node)
<strong>ties_trim_n:</strong> 0.2
<strong>dare_density:</strong> 0.45
                                </div>
                                <p class="text-xs text-slate-500 mt-4"><strong>Justification:</strong> `dare_density: 0.45` is moderately high, dropping many minor changes to keep the host's structure intact. `ties_trim_n: 0.2` keeps only the top 20% most impactful style changes from Boomer Art.</p>
                            </div>
                            <div class="p-6 border border-slate-700 rounded-lg bg-slate-900/50">
                                <h4 class="font-bold text-lg text-slate-200 mb-4">Step 2b: Inject Thematic Content (`D34D.CH4NN3L`)</h4>
                                <p class="text-sm text-slate-400 mb-4">This step injects the dark, gritty concepts. The settings are more conservative to add thematic elements without corrupting the style established in the previous steps.</p>
                                <div class="code-block">
<strong class="text-red-300">Node Setup:</strong> `TIES Merge (DARE)`
<strong>model_a (Host):</strong> <em>Output from Step 2a</em>
<strong>model_b (Donor):</strong> D34D.CH4NN3L.SDXL
<strong>base_model_a:</strong> kohaku-xl-beta5.safetensors
<strong>base_model_b:</strong> sd_xl_base_1.0.safetensors
<strong>dare_setup -></strong> (Connect `DARE Setup` node)
<strong>ties_trim_n:</strong> 0.25
<strong>dare_density:</strong> 0.25
                                </div>
                                 <p class="text-xs text-slate-500 mt-4"><strong>Justification:</strong> A lower `dare_density` (0.25) and higher `ties_trim_n` (0.25) means we are applying a wider, but less aggressive, set of changes. This is ideal for adding thematic content without destroying the existing aesthetic.</p>
                            </div>
                         </div>
                         <p class="text-sm text-slate-400 mt-6"><strong>Note on "Host Protection Mask":</strong> This is not a direct setting. The DARE-TIES process itself acts as a mask. By only applying a small, significant fraction of the donor's changes, it inherently "protects" the majority of the host model's original weights from being altered.</p>
                    </div>
                     <div class="card p-8">
                         <h3 class="text-xl font-bold text-slate-100 mb-4">Assembly: SDXL Donor Version</h3>
                         <p class="text-sm text-slate-400 mb-6">The CLIP and VAE strategy for this version must account for the different architectural families to ensure the model understands prompts and renders colors correctly.</p>
                         <div class="grid md:grid-cols-2 gap-8">
                             <div>
                                 <h4 class="font-bold text-lg text-slate-200 mb-4">Forging a Bilingual CLIP</h4>
                                 <p class="text-sm text-slate-400 mb-4">To prevent "lexicon clash" between the hosts' Danbooru tags and the donors' natural language, we create a "bilingual" CLIP via a sequential, three-step merge.</p>
                                 <div class="flex flex-col space-y-2 text-center text-xs font-semibold">
                                     <div class="p-2 border border-indigo-500/50 rounded-lg bg-indigo-900/20"><p class="font-medium mb-1 text-indigo-300">1. HOST CLIP</p><div class="flex justify-around items-center"><div class="p-2 bg-indigo-500/30 rounded-md text-indigo-200">Animij</div><div class="text-slate-400">+</div><div class="p-2 bg-indigo-500/30 rounded-md text-indigo-200">Graycolor</div></div><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(50/50)</span></div></div>
                                     <div class="p-2 border border-amber-500/50 rounded-lg bg-amber-900/20"><p class="font-medium mb-1 text-amber-300">2. DONOR CLIP</p><div class="flex justify-around items-center"><div class="p-2 bg-amber-500/30 rounded-md text-amber-200">Boomer Art</div><div class="text-slate-400">+</div><div class="p-2 bg-red-500/30 rounded-md text-red-200">D34D.CH4NN3L</div></div><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(50/50)</span></div></div>
                                     <div class="p-2 border border-slate-500 rounded-lg bg-slate-800/30"><p class="font-medium mb-1 text-slate-300">3. FINAL BLEND</p><div class="flex justify-around items-center"><div class="p-2 bg-indigo-500/50 rounded-md text-indigo-100">Host Merge</div><div class="text-slate-400 font-thin text-xl">+</div><div class="p-2 bg-amber-500/50 rounded-md text-amber-100">Donor Merge</div></div><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(65% Host / 35% Donor)</span></div><div class="p-3 bg-slate-200 rounded-lg text-slate-900 mx-auto mt-2">Final Bilingual CLIP</div></div>
                                 </div>
                             </div>
                             <div>
                                 <h4 class="font-bold text-lg text-slate-200 mb-4">VAE Selection for Fidelity</h4>
                                 <p class="text-sm text-slate-400 mb-6">Merging VAEs from different families is high-risk. To ensure maximum color fidelity and prevent artifacts, we do not merge. The host's original VAE is the safest choice.</p>
                                 <div class="bg-indigo-900/30 border-2 border-dashed border-indigo-500/50 p-4 rounded-lg text-center">
                                     <p class="font-semibold text-indigo-200">Primary Recommendation</p>
                                     <p class="text-indigo-300">Use the VAE baked into `Animij [Illustrious] V5.0`.</p>
                                     <p class="text-xs mt-2 text-indigo-400">This ensures the final image is decoded by a VAE perfectly matched to the host's core architecture.</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                </section>
            </div>

            <div id="pony-content" class="hidden">
                 <section id="pony-blueprints" class="mb-24 scroll-mt-20">
                     <h2 class="text-3xl font-bold text-slate-100 mb-2">Blueprint: PONY Family Strategy</h2>
                     <p class="text-slate-400 mb-10 max-w-4xl">This strategy stays within the "Pony" architectural family, ensuring high compatibility. It uses `NEW ERA V5.0` (an epsilon-prediction model based on the `NoobAI` family) and a re-calculated recipe to compensate for its weaker anatomy while leveraging its strong style, creating a highly coherent and polished result.</p>
                     <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1277670?modelVersionId=1772645" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">JANKU V4.0</h3></a><p class="text-sm font-medium text-indigo-400 mb-2">Primary Host / Structural Base</p><p class="text-sm text-slate-400 flex-grow">A versatile and gritty `NoobAI`-family model that will provide the core structure and a receptive foundation for dark themes.</p></div>
                         <div class="card p-6 flex flex-col ring-2 ring-red-500/50"><a href="https://civitai.com/models/137781?modelVersionId=1502081" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">NEW ERA V5.0</h3></a><p class="text-sm font-medium text-indigo-400 mb-2">Primary Thematic Base</p><p class="text-sm text-slate-400 flex-grow">An epsilon-prediction model with a strong style that will be merged with JANKU's superior anatomy to create a "Dark Anime" base.</p></div>
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1721372?modelVersionId=1948027" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">Graycolor SemiRealIllustMix</h3></a><p class="text-sm font-medium text-amber-400 mb-2">Painterly Style Foundation</p><p class="text-sm text-slate-400 flex-grow">An `Illustrious` model that provides a semi-realistic, painterly base for the final textural finish.</p></div>
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1552304?modelVersionId=1782085" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">SinGlo V2.0</h3></a><p class="text-sm font-medium text-amber-400 mb-2">Textural Detail Donor</p><p class="text-sm text-slate-400 flex-grow">An `Illustrious` model with a unique, sharp, and detailed style that will be blended with Graycolor to add textural complexity.</p></div>
                     </div>
                 </section>
                 <section id="pony-recipes" class="mb-24 scroll-mt-20">
                     <h2 class="text-3xl font-bold text-slate-100 mb-2">Recipe & Implementation: PONY Family</h2>
                     <div class="card p-6 md:p-8 mb-12">
                         <h3 class="text-xl font-bold text-slate-100 mb-4">Multi-Stage Block Merge Recipes</h3>
                         <p class="text-sm text-slate-400 mb-6">This approach uses a sequence of merges to build the final model layer by layer. Select a merge stage to view its specific recipe. The chart will update to show the block weights for the selected stage. Hover over any block for a detailed justification.</p>
                         <div class="flex justify-center flex-wrap gap-4 mb-6">
                             <button id="recipe-pony-stage1" class="recipe-btn active px-4 py-2 rounded-md text-sm font-medium">Stage 1: "Dark Anime" Base</button>
                             <button id="recipe-pony-stage2" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Stage 2: "Painterly Bridge"</button>
                             <button id="recipe-pony-stage3" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Stage 3: Final Fusion</button>
                         </div>
                         <div class="chart-container"><canvas id="ponyChart"></canvas></div>
                         <div id="pony-justification" class="mt-6 p-4 bg-slate-800 rounded-md text-sm text-slate-400 min-h-[60px]">Select a recipe and hover over a block in the chart to see the justification for its weighting.</div>
                     </div>
                      <div class="card p-8">
                          <h3 class="text-xl font-bold text-slate-100 mb-4">Assembly: PONY Family Version</h3>
                          <p class="text-sm text-slate-400 mb-6">Even within the Pony family, the `NoobAI` and `Illustrious` branches have different "vocabularies." A sequential CLIP merge is still recommended for maximum control and prompt understanding.</p>
                          <div class="grid md:grid-cols-2 gap-8">
                              <div>
                                  <h4 class="font-bold text-lg text-slate-200 mb-4">Forging a Coherent CLIP</h4>
                                  <p class="text-sm text-slate-400 mb-4">This sequential merge ensures the final CLIP understands prompts related to both the `NoobAI` base and the `Illustrious` style layer.</p>
                                  <div class="flex flex-col space-y-2 text-center text-xs font-semibold">
                                       <div class="p-2 border border-indigo-500/50 rounded-lg bg-indigo-900/20"><p class="font-medium mb-1 text-indigo-300">1. `NoobAI` CLIP</p><div class="flex justify-around items-center"><div class="p-2 bg-indigo-500/30 rounded-md text-indigo-200">JANKU</div><div class="text-slate-400">+</div><div class="p-2 bg-indigo-500/30 rounded-md text-indigo-200">NEW ERA</div></div><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(50/50)</span></div></div>
                                       <div class="p-2 border border-amber-500/50 rounded-lg bg-amber-900/20"><p class="font-medium mb-1 text-amber-300">2. `Illustrious` CLIP</p><div class="flex justify-around items-center"><div class="p-2 bg-amber-500/30 rounded-md text-amber-200">Graycolor</div><div class="text-slate-400">+</div><div class="p-2 bg-amber-500/30 rounded-md text-amber-200">SinGlo</div></div><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(50/50)</span></div></div>
                                       <div class="p-2 border border-slate-500 rounded-lg bg-slate-800/30"><p class="font-medium mb-1 text-slate-300">3. FINAL BLEND</p><div class="flex justify-around items-center"><div class="p-2 bg-indigo-500/50 rounded-md text-indigo-100">`NoobAI` Merge</div><div class="text-slate-400 font-thin text-xl">+</div><div class="p-2 bg-amber-500/50 rounded-md text-amber-100">`Illustrious` Merge</div></div><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(70% NoobAI / 30% Illustrious)</span></div><div class="p-3 bg-slate-200 rounded-lg text-slate-900 mx-auto mt-2">Final Coherent CLIP</div></div>
                                  </div>
                              </div>
                              <div>
                                  <h4 class="font-bold text-lg text-slate-200 mb-4">VAE Selection for Fidelity</h4>
                                  <p class="text-sm text-slate-400 mb-6">While all models are from the Pony family, using the VAE from the final Primary Host (`JANKU`) is the safest choice for color accuracy and avoiding visual artifacts.</p>
                                  <div class="bg-indigo-900/30 border-2 border-dashed border-indigo-500/50 p-4 rounded-lg text-center">
                                      <p class="font-semibold text-indigo-200">Primary Recommendation</p>
                                      <p class="text-indigo-300">Use the VAE baked into `JANKU V4.0`.</p>
                                      <p class="text-xs mt-2 text-indigo-400">This ensures the final image is decoded by a VAE perfectly matched to the final merge's structural base.</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                 </section>
            </div>
            
            <div id="hybrid-content" class="hidden">
                 <section id="hybrid-blueprints" class="mb-24 scroll-mt-20">
                     <h2 class="text-3xl font-bold text-slate-100 mb-2">Blueprint: PONY + SDXL Hybrid Strategy</h2>
                     <p class="text-slate-400 mb-10 max-w-4xl">This advanced strategy creates a Pony-family base and then uses a surgical DARE-TIES injection from an SDXL model to "patch" specific weaknesses, such as anatomy. It's the most complex but offers a unique way to get the best of both worlds.</p>
                     <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-6">
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1277670?modelVersionId=1772645" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">JANKU V4.0</h3></a><p class="text-sm font-medium text-indigo-400 mb-2">Structural Base</p><p class="text-sm text-slate-400 flex-grow">Forms the anatomical and compositional foundation of the Pony base model.</p></div>
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/137781?modelVersionId=1502081" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">NEW ERA V5.0</h3></a><p class="text-sm font-medium text-indigo-400 mb-2">Thematic Base</p><p class="text-sm text-slate-400 flex-grow">Contributes the core retro anime aesthetic and thematic direction to the Pony base.</p></div>
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1721372?modelVersionId=1948027" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">Graycolor</h3></a><p class="text-sm font-medium text-amber-400 mb-2">Painterly Base</p><p class="text-sm text-slate-400 flex-grow">Introduces a semi-realistic, painterly quality to soften the anime look.</p></div>
                         <div class="card p-6 flex flex-col"><a href="https://civitai.com/models/1552304?modelVersionId=1782085" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">SinGlo V2.0</h3></a><p class="text-sm font-medium text-amber-400 mb-2">Textural Donor</p><p class="text-sm text-slate-400 flex-grow">Adds sharp, complex textural details for a more refined final aesthetic.</p></div>
                         <div class="card p-6 flex flex-col ring-2 ring-red-500/50"><a href="https://civitai.com/models/163139?modelVersionId=481390" target="_blank" class="hover:underline"><h3 class="font-bold text-lg text-slate-100">Boomer Art</h3></a><p class="text-sm font-medium text-red-400 mb-2">Anatomical Patcher</p><p class="text-sm text-slate-400 flex-grow">Chosen for its strong anatomical knowledge, this SDXL model is used to surgically correct flaws in the Pony base.</p></div>
                     </div>
                 </section>
                 <section id="hybrid-recipes" class="mb-24 scroll-mt-20">
                     <h2 class="text-3xl font-bold text-slate-100 mb-2">Recipe & Implementation: PONY + SDXL Hybrid</h2>
                     <div class="card p-6 md:p-8 mb-12">
                         <h3 class="text-xl font-bold text-slate-100 mb-4">Four-Stage Hybrid Merge Recipe</h3>
                         <p class="text-sm text-slate-400 mb-6">This complex recipe involves two initial block merges, a surgical DARE-TIES injection, and a final block merge fusion. Select a stage to view its recipe. Note that Stage 3 is a DARE-TIES process and will not show a chart, but will display the parameters for the surgical injection.</p>
                         <div class="flex justify-center flex-wrap gap-4 mb-6">
                             <button id="recipe-hybrid-stage1" class="recipe-btn active px-4 py-2 rounded-md text-sm font-medium">Stage 1: Dark Anime Base</button>
                             <button id="recipe-hybrid-stage2" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Stage 2: Painterly Bridge</button>
                             <button id="recipe-hybrid-stage3" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Stage 3: Anatomical Patch</button>
                             <button id="recipe-hybrid-stage4" class="recipe-btn px-4 py-2 rounded-md text-sm font-medium">Stage 4: Final Fusion</button>
                         </div>
                         <div id="hybrid-recipe-explanation" class="mb-6 p-4 bg-indigo-900/30 border border-indigo-500/50 text-indigo-200 rounded-md text-sm" style="display: none;"></div>
                         <div class="chart-container"><canvas id="hybridChart"></canvas></div>
                         <div id="hybrid-justification" class="mt-6 p-4 bg-slate-800 rounded-md text-sm text-slate-400 min-h-[60px]">Select a recipe and hover over a block for justification.</div>
                     </div>
                      <div class="card p-8">
                          <h3 class="text-xl font-bold text-slate-100 mb-4">Assembly: PONY + SDXL Hybrid Version</h3>
                          <p class="text-sm text-slate-400 mb-6">The CLIP merge for this version is the most complex, requiring a three-way blend to incorporate the vocabularies of all five parent models from three different families (`NoobAI`, `Illustrious`, `SDXL`). This creates a "trilingual" CLIP that can understand prompts related to all parent models.</p>
                          <div class="grid md:grid-cols-2 gap-8">
                              <div>
                                  <h4 class="font-bold text-lg text-slate-200 mb-4">Forging a Trilingual CLIP</h4>
                                  <p class="text-sm text-slate-400 mb-4">We create three vocabulary groups and then perform a final weighted merge to balance their influence, ensuring the Pony base remains dominant while still understanding prompts for the injected anatomical skill.</p>
                                  <div class="flex flex-col space-y-2 text-center text-xs font-semibold">
                                      <div class="p-2 border border-indigo-500/50 rounded-lg bg-indigo-900/20"><p class="font-medium mb-1 text-indigo-300">1. `NoobAI` CLIP (JANKU + NEW ERA)</p></div>
                                      <div class="p-2 border border-amber-500/50 rounded-lg bg-amber-900/20"><p class="font-medium mb-1 text-amber-300">2. `Illustrious` CLIP (Graycolor + SinGlo)</p></div>
                                      <div class="p-2 border border-red-500/50 rounded-lg bg-red-900/20"><p class="font-medium mb-1 text-red-300">3. `SDXL` CLIP (Boomer Art)</p></div>
                                      <div class="p-2 border border-slate-500 rounded-lg bg-slate-800/30"><p class="font-medium mb-1 text-slate-300">4. FINAL BLEND</p><div class="self-center mt-1 text-slate-400">↓ <span class="font-normal">(60% NoobAI / 25% Illustrious / 15% SDXL)</span></div><div class="p-3 bg-slate-200 rounded-lg text-slate-900 mx-auto mt-2">Final Trilingual CLIP</div></div>
                                  </div>
                              </div>
                              <div>
                                  <h4 class="font-bold text-lg text-slate-200 mb-4">VAE Selection for Fidelity</h4>
                                  <p class="text-sm text-slate-400 mb-6">The VAE from the primary structural host, `JANKU V4.0`, remains the safest and most logical choice to maintain color consistency despite the complex merges.</p>
                                  <div class="bg-indigo-900/30 border-2 border-dashed border-indigo-500/50 p-4 rounded-lg text-center">
                                      <p class="font-semibold text-indigo-200">Primary Recommendation</p>
                                      <p class="text-indigo-300">Use the VAE baked into `JANKU V4.0`.</p>
                                      <p class="text-xs mt-2 text-indigo-400">Because the final model is overwhelmingly Pony-based, using the Pony VAE is non-negotiable to prevent color shifts and artifacts.</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                 </section>
            </div>

            <section id="analysis" class="mb-24 scroll-mt-20">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">Comparative Analysis & Recommendation</h2>
                <p class="text-slate-400 mb-10 max-w-4xl">Choosing a merge strategy involves a trade-off between stability, stylistic reach, and complexity. This section summarizes the key differences to help you decide which version best suits your specific needs.</p>
                <div class="overflow-x-auto card p-2 md:p-6">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800/50 text-slate-200">
                            <tr>
                                <th class="p-3 font-semibold">Factor</th>
                                <th class="p-3 font-semibold">"SDXL Donor"</th>
                                <th class="p-3 font-semibold">"PONY Family"</th>
                                <th class="p-3 font-semibold">"PONY + SDXL Hybrid"</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            <tr class="hover:bg-slate-800/30">
                                <td class="p-3 font-medium text-slate-200">Core Philosophy</td>
                                <td class="p-3">Surgical Skill Injection (DARE-TIES)</td>
                                <td class="p-3">Architectural Harmony (Block Merge)</td>
                                <td class="p-3">Hybrid: Block Merge + Surgical Patching</td>
                            </tr>
                            <tr class="hover:bg-slate-800/30">
                                <td class="p-3 font-medium text-slate-200">Stability & Coherence</td>
                                <td class="p-3">Good, but higher risk of subtle artifacts due to cross-architecture merging.</td>
                                <td class="p-3">Excellent. Merging compatible models is fundamentally more stable and predictable.</td>
                                <td class="p-3">Very Good. Primarily stable due to Pony base, but the SDXL injection introduces a minor risk factor.</td>
                            </tr>
                            <tr class="hover:bg-slate-800/30">
                                <td class="p-3 font-medium text-slate-200">Stylistic Reach</td>
                                <td class="p-3">Widest. Can incorporate styles from completely different model families.</td>
                                <td class="p-3">Focused. Excels at blending styles within the Pony ecosystem for a refined aesthetic.</td>
                                <td class="p-3">Unique. Creates a novel blend by "patching" a Pony base with an SDXL model's specific traits (anatomy).</td>
                            </tr>
                             <tr class="hover:bg-slate-800/30">
                                <td class="p-3 font-medium text-slate-200">Complexity</td>
                                <td class="p-3">High. Requires careful setup of DARE-TIES nodes and base models.</td>
                                <td class="p-3">Medium. A straightforward multi-stage block merge.</td>
                                <td class="p-3">Very High. Combines both block merging and DARE-TIES in a four-stage process.</td>
                            </tr>
                             <tr class="hover:bg-slate-800/30">
                                <td class="p-3 font-medium text-slate-200">Best For...</td>
                                <td class="p-3">Achieving a very specific, unique blend of disparate aesthetics (e.g., sci-fi on a fantasy base).</td>
                                <td class="p-3">Creating a highly polished, stable, and coherent model for consistent asset generation (e.g. character sheets).</td>
                                <td class="p-3">Experimental merging to fix specific flaws (e.g., poor anatomy) in a base model using a donor from another family.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <div class="mt-8 p-6 bg-indigo-900/30 border border-indigo-500/50 rounded-lg">
                     <h3 class="font-bold text-lg text-indigo-200 mb-2">Final Recommendation</h3>
                     <p class="text-indigo-300">For the stated goal of creating **coherent game assets** with **clear lines suitable for vectorization**, the **"PONY Family" version remains the superior choice.**</p>
                     <p class="mt-2 text-sm text-indigo-400">Its architectural harmony provides the highest degree of stability and predictability, which is critical when generating a large set of consistent assets. The **"PONY + SDXL Hybrid"** is a powerful and highly creative alternative for advanced users, but its complexity and the slight risk introduced by the DARE-TIES patch make it a secondary, more experimental option. The **"SDXL Donor"** version is best reserved for when a desired aesthetic truly cannot be achieved within a single architectural family.</p>
                 </div>
            </section>
            
            <section id="glossary" class="mb-24 scroll-mt-20">
                 <h2 class="text-3xl font-bold text-slate-100 mb-2">Glossary of Terms</h2>
                 <p class="text-slate-400 mb-10 max-w-4xl">Understanding the terminology is key to successful model merging. Here are definitions for the core concepts discussed in this guide.</p>
                 <div class="grid md:grid-cols-2 gap-6">
                     <div class="card p-6">
                         <h3 class="font-bold text-lg text-slate-200 mb-2">Block-Weighted Merge</h3>
                         <p class="text-sm text-slate-400">A merging technique where different layers (blocks) of two neural networks are combined with different weights. Early layers (IN blocks) control composition and anatomy, middle layers (M block) control concepts and semantics, and late layers (OUT blocks) control details and style. This allows for very precise control over what each parent model contributes to the final result.</p>
                     </div>
                     <div class="card p-6">
                         <h3 class="font-bold text-lg text-slate-200 mb-2">DARE-TIES</h3>
                         <p class="text-sm text-slate-400">An advanced merging algorithm for surgically injecting skills from a donor model into a host model, especially across different architectures. Implemented in ComfyUI via the `ComfyUI-DareMerge` extension, it requires a specific node setup:
                         <br><br>• <strong>Node Setup:</strong> The core node is `TIES Merge (DARE)`. It takes the host (`model_a`), donor (`model_b`), and critically, their original base models (`base_model_a`, `base_model_b`) to calculate the difference. A `DARE Setup` node is connected to it to control the `dare_density`.
                         <br>• <strong>TIES (`ties_trim_n`):</strong> Trims the calculated changes, keeping only the most significant ones. A value of `0.2` keeps the top 20%.
                         <br>• <strong>DARE (`dare_density`):</strong> Randomly drops a percentage of the *already trimmed* changes to prevent overfitting. A value of `0.25` drops 25% of the remaining changes.</p>
                     </div>
                     <div class="card p-6">
                         <h3 class="font-bold text-lg text-slate-200 mb-2">UNet</h3>
                         <p class="text-sm text-slate-400">The core neural network architecture used in diffusion models for image generation. It has an "encoder" part that compresses the image into a conceptual representation (the IN and M blocks) and a "decoder" part that reconstructs the image from that representation (the OUT blocks). Its "U" shape allows information to be passed between corresponding encoder and decoder layers, preserving details.</p>
                     </div>
                     <div class="card p-6">
                         <h3 class="font-bold text-lg text-slate-200 mb-2">CLIP (Contrastive Language-Image Pre-Training)</h3>
                         <p class="text-sm text-slate-400">The component of the model that understands text prompts. It translates your words into a mathematical representation that the UNet can use to guide image generation. Merging CLIPs is crucial for making a model that understands the combined vocabulary of its parents.</p>
                     </div>
                     <div class="card p-6">
                         <h3 class="font-bold text-lg text-slate-200 mb-2">VAE (Variational Autoencoder)</h3>
                         <p class="text-sm text-slate-400">A small neural network that handles the final step of image creation. It translates the UNet's output into the actual pixels you see. A good VAE ensures vibrant colors and sharp details, while a mismatched one can cause desaturated colors or visual artifacts. It's generally safest to use the VAE from the primary host or base model.</p>
                     </div>
                      <div class="card p-6">
                         <h3 class="font-bold text-lg text-slate-200 mb-2">Architectural Family (e.g., SDXL vs. Pony)</h3>
                         <p class="text-sm text-slate-400">Refers to groups of models trained on a similar base and with compatible internal structures. Merging models from the same family (e.g., Pony + Pony) is generally more stable and predictable than merging across families (e.g., Pony + SDXL), which often requires more advanced techniques like DARE-TIES to resolve incompatibilities.</p>
                     </div>
                 </div>
            </section>

        </main>
        
        <footer class="bg-slate-900/50 mt-24 border-t border-slate-700">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-slate-500">
                <p>Consolidated Interactive Guide to Advanced Model Merging</p>
            </div>
        </footer>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

    const canvas = document.getElementById('shader-canvas');
    const gl = canvas.getContext('webgl');
    if (!gl) {
        console.error("WebGL not supported, background will not be animated.");
        return;
    }

    const vertexShaderSource = `
        attribute vec2 a_position;
        void main() {
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    `;

    const fragmentShaderSource = `
        precision mediump float;
        uniform vec2 u_resolution;
        uniform float u_time;

        // 2D Random
        float random (vec2 st) {
            return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);
        }

        // 2D Noise
        float noise (vec2 st) {
            vec2 i = floor(st);
            vec2 f = fract(st);
            vec2 u = f*f*(3.0-2.0*f);
            return mix( mix( random( i + vec2(0.0,0.0) ),
                           random( i + vec2(1.0,0.0) ), u.x),
                        mix( random( i + vec2(0.0,1.0) ),
                           random( i + vec2(1.0,1.0) ), u.x), u.y);
        }

        mat2 rotate(float a) {
            float s = sin(a);
            float c = cos(a);
            return mat2(c, -s, s, c);
        }

        // Fractional Brownian Motion
        float fbm (vec2 st) {
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;
            for (int i = 0; i < 6; i++) {
                value += amplitude * noise(st);
                st *= 2.;
                amplitude *= .5;
            }
            return value;
        }

        void main() {
            vec2 st = gl_FragCoord.xy/u_resolution.xy;
            st.x *= u_resolution.x/u_resolution.y;

            vec3 color = vec3(0.0);
            
            vec2 q = vec2(0.);
            q.x = fbm( st + 0.00*u_time);
            q.y = fbm( st + vec2(1.0));

            vec2 r = vec2(0.);
            r.x = fbm( st + 1.0*q + vec2(1.7,9.2)+ 0.15*u_time );
            r.y = fbm( st + 1.0*q + vec2(8.3,2.8)+ 0.126*u_time);

            float f = fbm(st+r);

            color = mix(vec3(0.101961,0.098039,0.2),
                        vec3(0.368627,0.368627,0.6),
                        clamp((f*f)*4.0,0.0,1.0));

            color = mix(color,
                        vec3(0.2,0.1,0.4),
                        clamp(length(q),0.0,1.0));

            color = mix(color,
                        vec3(0.4,0.5,0.7),
                        clamp(length(r.x),0.0,1.0));
            
            // Starfield
            float star_density = 0.998;
            float star_val = random(gl_FragCoord.xy);
            if (star_val > star_density) {
                float star_intensity = (star_val - star_density) / (1.0 - star_density);
                color += vec3(star_intensity * (0.8 + 0.2 * sin(u_time * 2.0 + gl_FragCoord.y)));
            }

            gl_FragColor = vec4( (f*f*f+.6*f*f+.5*f)*color, 1.);
        }
    `;

    function createShader(gl, type, source) {
        const shader = gl.createShader(type);
        gl.shaderSource(shader, source);
        gl.compileShader(shader);
        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            console.error('An error occurred compiling the shaders: ' + gl.getShaderInfoLog(shader));
            gl.deleteShader(shader);
            return null;
        }
        return shader;
    }

    const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
    const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);

    const program = gl.createProgram();
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    gl.linkProgram(program);

    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
        console.error('Unable to initialize the shader program: ' + gl.getProgramInfoLog(program));
        return;
    }

    gl.useProgram(program);

    const positionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    const positions = [-1, 1, 1, 1, -1, -1, 1, -1];
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);
    
    const positionAttributeLocation = gl.getAttribLocation(program, "a_position");
    gl.enableVertexAttribArray(positionAttributeLocation);
    gl.vertexAttribPointer(positionAttributeLocation, 2, gl.FLOAT, false, 0, 0);

    const resolutionUniformLocation = gl.getUniformLocation(program, "u_resolution");
    const timeUniformLocation = gl.getUniformLocation(program, "u_time");

    function render(time) {
        time *= 0.001; 
        
        canvas.width = gl.canvas.clientWidth;
        canvas.height = gl.canvas.clientHeight;
        gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

        gl.uniform2f(resolutionUniformLocation, gl.canvas.width, gl.canvas.height);
        gl.uniform1f(timeUniformLocation, time);

        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

        requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
        
    const blockLabels = ['IN00', 'IN01', 'IN02', 'IN03', 'IN04', 'IN05', 'IN06', 'IN07', 'IN08', 'IN09', 'IN10', 'IN11', 'M00', 'OUT00', 'OUT01', 'OUT02', 'OUT03', 'OUT04', 'OUT05', 'OUT06', 'OUT07', 'OUT08', 'OUT09', 'OUT10', 'OUT11'];
    
    const sdxlData = {
        labels: blockLabels,
        recipes: {
            balanced: {
                explanation: "<strong>Recipe A: Balanced (Default)</strong><br>This is the recommended recipe, meticulously calculated to balance Animij's structural integrity with Graycolor's stylistic contributions. It heavily favors Animij in the early blocks for composition, smoothly blends towards Graycolor in the middle for conceptual style, and then shifts back to Animij in the final blocks for clean linework.",
                weights: [0.90, 0.88, 0.85, 0.82, 0.75, 0.70, 0.65, 0.60, 0.55, 0.50, 0.48, 0.45, 0.40, 0.42, 0.45, 0.48, 0.50, 0.53, 0.58, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90],
                justifications: ['IN00 @ 0.90 Animij: Establishes overwhelming dominance for the host\'s core compositional understanding and clean lineart style from the very first block.','IN01 @ 0.88 Animij: Continues strong host dominance to lock in anatomical structure and posing, critical for coherent character art.','IN02 @ 0.85 Animij: The host still leads, ensuring the primary subject\'s form is defined by its superior anime style before other influences are introduced.','IN03 @ 0.82 Animij: A slight increase in Graycolor\'s influence (0.18) begins to subtly soften the purely anime aesthetic in preparation for the style blend.','IN04 @ 0.75 Animij: A significant step towards Graycolor (0.25), introducing its semi-realistic properties and painterly concepts into the established anime structure.','IN05 @ 0.70 Animij: Graycolor\'s influence grows to 0.30, allowing it to affect how mid-level features like faces and clothing are interpreted.','IN06 @ 0.65 Animij: The blend continues towards an equilibrium, giving Graycolor (0.35) more say in style and texture before the conceptual core.','IN07 @ 0.60 Animij: Nearing the middle block, the models approach an even balance (0.40 Graycolor) to prepare for the main style fusion.','IN08 @ 0.55 Animij: The host maintains a slight edge just before the bottleneck, ensuring its structural integrity is the final word of the input stage.','IN09 @ 0.50/0.50: An exact 50/50 split to create a perfectly balanced and stable transition into the UNET\'s semantic core.','IN10 @ 0.48 Animij: Graycolor takes a slight lead (0.52) for the first time, beginning to define the abstract concept with its semi-realistic style.','IN11 @ 0.45 Animij: Further strengthens Graycolor\'s conceptual dominance (0.55) right before the middle block, ensuring its style is deeply embedded.','M00 @ 0.40 Animij: Graycolor is given its strongest weight (0.60) at the UNET bottleneck. This ensures its semi-realistic, painterly style is embedded in the deepest semantic layer.','OUT00 @ 0.42 Animij: Graycolor remains dominant (0.58) as the model begins to reconstruct the image, propagating its style outwards from the core.','OUT01 @ 0.45 Animij: The balance begins to shift back towards the host, re-introducing Animij\'s structural logic into the reconstruction.','OUT02 @ 0.48 Animij: Graycolor still holds a slight majority (0.52), ensuring its painterly style continues to influence the early detail layers.','OUT03 @ 0.50/0.50: A second perfect 50/50 split, creating a fused block that draws equally from both models\' approaches to detail and texture.','OUT04 @ 0.53 Animij: The host retakes the lead, beginning to apply its clean, stylized interpretation to the reconstructed features.','OUT05 @ 0.58 Animij: The emphasis on the host grows, focusing on its superior ability to generate clean lines and cel-style shading.','OUT06 @ 0.65 Animij: A stronger weight for the host ensures that fine details like eyes, hair strands, and accessories adhere to the target anime aesthetic.','OUT07 @ 0.70 Animij: The host continues to dominate, refining textures to match its retro style while retaining some of Graycolor\'s painterly grit.','OUT08 @ 0.75 Animij: A significant weight for the host to perform a final pass on the overall structure and composition, ensuring coherence.','OUT09 @ 0.80 Animij: Heavily favors the host for rendering the final, high-frequency details with maximum clarity and sharpness.','OUT10 @ 0.85 Animij: Overwhelmingly favors the host to ensure the final linework is crisp and clean, which is critical for the goal of vectorization.','OUT11 @ 0.90 Animij: A final, decisive weight for the host to ensure the output is clean, vibrant, and consistent with its core style, removing any latent noise.']
            },
            host_dominant: {
                explanation: "<strong>Recipe B: Host-Dominant</strong><br>This recipe gives more weight to Animij across all blocks. The result will be a model with exceptionally strong anatomy and compositional coherence, closely adhering to the retro anime style. However, it will be less receptive to the painterly style of the donors, which may appear more subtle.",
                weights: [0.95, 0.92, 0.90, 0.88, 0.85, 0.80, 0.75, 0.70, 0.65, 0.60, 0.55, 0.50, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.88, 0.90, 0.92, 0.95],
                justifications: ['(Host-Dominant) IN00 @ 0.95 Animij: Maximum structural integrity from the start.','(Host-Dominant) IN01 @ 0.92 Animij: Maintain overwhelming control over anatomy.','(Host-Dominant) IN02 @ 0.90 Animij: Ensure subject form is purely Animij.','(Host-Dominant) IN03 @ 0.88 Animij: Minimal influence from Graycolor.','(Host-Dominant) IN04 @ 0.85 Animij: Prioritize structure over style blending.','(Host-Dominant) IN05 @ 0.80 Animij: Keep the core style very close to Animij.','(Host-Dominant) IN06 @ 0.75 Animij: A 3:1 ratio favoring structure.','(Host-Dominant) IN07 @ 0.70 Animij: Strong host control leading into the middle.','(Host-Dominant) IN08 @ 0.65 Animij: Ensure Animij has the last word before the core.','(Host-Dominant) IN09 @ 0.60 Animij: A host-favored blend for stability.','(Host-Dominant) IN10 @ 0.55 Animij: A slight host bias even during concept formation.','(Host-Dominant) IN11 @ 0.50/0.50: An even split right before the core.','(Host-Dominant) M00 @ 0.45 Animij: Even at the core, maintain a strong host presence.','(Host-Dominant) OUT00 @ 0.50/0.50: Start reconstruction with an even split.','(Host-Dominant) OUT01 @ 0.55 Animij: Immediately begin re-asserting host control.','(Host-Dominant) OUT02 @ 0.60 Animij: Strengthen host control over early details.','(Host-Dominant) OUT03 @ 0.65 Animij: Prioritize host logic for detail refinement.','(Host-Dominant) OUT04 @ 0.70 Animij: Strong host control over feature reconstruction.','(Host-Dominant) OUT05 @ 0.75 Animij: A 3:1 ratio favoring host linework.','(Host-Dominant) OUT06 @ 0.80 Animij: Overwhelmingly favor host for fine details.','(Host-Dominant) OUT07 @ 0.85 Animij: Ensure textures are primarily from the host.','(Host-Dominant) OUT08 @ 0.88 Animij: Final structural polish is almost entirely host-driven.','(Host-Dominant) OUT09 @ 0.90 Animij: Maximum clarity from the host.','(Host-Dominant) OUT10 @ 0.92 Animij: Ensure linework is exceptionally clean.','(Host-Dominant) OUT11 @ 0.95 Animij: Final output is almost pure Animij style.']
            },
            donor_receptive: {
                explanation: "<strong>Recipe C: Donor-Receptive</strong><br>This recipe gives more weight to Graycolor. This creates a host model that is more stylistically flexible and will be more receptive to the painterly and thematic donors. The trade-off is a potential reduction in compositional stability and a less distinct '90s anime' feel.",
                weights: [0.85, 0.82, 0.80, 0.78, 0.70, 0.65, 0.60, 0.55, 0.50, 0.45, 0.42, 0.40, 0.35, 0.38, 0.40, 0.42, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85],
                justifications: ['(Donor-Receptive) IN00 @ 0.85 Animij: A softer start, immediately allowing more style influence.','(Donor-Receptive) IN01 @ 0.82 Animij: Weaken host control early to encourage blending.','(Donor-Receptive) IN02 @ 0.80 Animij: A 4:1 ratio, giving Graycolor a strong early voice.','(Donor-Receptive) IN03 @ 0.78 Animij: Continue to prioritize style blending over pure structure.','(Donor-Receptive) IN04 @ 0.70 Animij: A strong push towards Graycolor\'s style.','(Donor-Receptive) IN05 @ 0.65 Animij: Allow Graycolor significant influence on features.','(Donor-Receptive) IN06 @ 0.60 Animij: A 60/40 split favoring structure, but with strong style.','(Donor-Receptive) IN07 @ 0.55 Animij: Approach the middle with a near-even split.','(Donor-Receptive) IN08 @ 0.50/0.50: An even split to maximize fusion potential.','(Donor-Receptive) IN09 @ 0.45 Animij: Let Graycolor lead the transition to the core.','(Donor-Receptive) IN10 @ 0.42 Animij: Strengthen Graycolor\'s conceptual influence.','(Donor-Receptive) IN11 @ 0.40 Animij: A strong 60% Graycolor weight before the bottleneck.','(Donor-Receptive) M00 @ 0.35 Animij: Give Graycolor a decisive 65% weight at the core.','(Donor-Receptive) OUT00 @ 0.38 Animij: Begin reconstruction with a strong Graycolor influence.','(Donor-Receptive) OUT01 @ 0.40 Animij: Maintain a 60% Graycolor weight in early reconstruction.','(Donor-Receptive) OUT02 @ 0.42 Animij: Continue to prioritize the painterly style.','(Donor-Receptive) OUT03 @ 0.45 Animij: A donor-favored split for detail refinement.','(Donor-Receptive) OUT04 @ 0.50/0.50: An even split for the final feature pass.','(Donor-Receptive) OUT05 @ 0.55 Animij: Begin shifting back to Animij for linework.','(Donor-Receptive) OUT06 @ 0.60 Animij: A 60/40 split favoring host for fine details.','(Donor-Receptive) OUT07 @ 0.65 Animij: Strengthen host control over final textures.','(Donor-Receptive) OUT08 @ 0.70 Animij: A 70/30 split for the final structural polish.','(Donor-Receptive) OUT09 @ 0.75 Animij: A strong host presence for clarity.','(Donor-Receptive) OUT10 @ 0.80 Animij: Ensure final linework is mostly from the host.','(Donor-Receptive) OUT11 @ 0.85 Animij: A strong host weight for a clean finish.']
            }
        }
    };

    const ponyData = {
        labels: blockLabels,
        recipes: {
            stage1: { model1: 'JANKU', model2: 'NEW ERA V5', color1: '#6366F1', color2: '#312E81', weights: [0.90,0.88,0.85,0.82,0.80,0.75,0.70,0.65,0.60,0.55,0.50,0.48,0.45,0.50,0.55,0.60,0.65,0.70,0.75,0.80,0.82,0.85,0.88,0.90,0.92], justifications: ['Stage 1 (JANKU/NEW ERA V5) - IN00 @ 0.90 JANKU: Overwhelmingly favor JANKU\'s superior anatomy to build a strong structural foundation, compensating for NEW ERA\'s weakness.','Stage 1 - IN01 @ 0.88 JANKU: Continue strong JANKU dominance to lock in composition and posing.','Stage 1 - IN02 @ 0.85 JANKU: Maintain a heavy JANKU bias while beginning to introduce NEW ERA\'s powerful thematic style.','Stage 1 - IN03 @ 0.82 JANKU: Gradually increase NEW ERA\'s influence, allowing its style to blend with the strong structure.','Stage 1 - IN04 @ 0.80 JANKU: A 4:1 ratio ensures JANKU\'s anatomy remains dominant as NEW ERA\'s style becomes more prominent.','Stage 1 - IN05 @ 0.75 JANKU: A significant step, giving NEW ERA a 25% say in mid-level features.','Stage 1 - IN06 @ 0.70 JANKU: Allow NEW ERA\'s style to strongly influence the image, balanced by JANKU\'s coherence.','Stage 1 - IN07 @ 0.65 JANKU: Move towards a more even blend before the conceptual core.','Stage 1 - IN08 @ 0.60 JANKU: Give NEW ERA a strong 40% influence before the bottleneck.','Stage 1 - IN09 @ 0.55 JANKU: A near-even split, slightly favoring JANKU for stability.','Stage 1 - IN10 @ 0.50/0.50: A perfectly balanced split for a stable transition into the core.','Stage 1 - IN11 @ 0.48 JANKU: Allow NEW ERA a slight edge (52%) to define the abstract concept.','Stage 1 - M00 @ 0.45 JANKU: Give NEW ERA a clear 55% majority at the core to ensure its dark, gritty themes are deeply embedded.','Stage 1 - OUT00 @ 0.50/0.50: Begin reconstruction with a balanced split for a novel fusion.','Stage 1 - OUT01 @ 0.55 JANKU: Immediately begin re-asserting JANKU\'s structural control during decoding.','Stage 1 - OUT02 @ 0.60 JANKU: Increase JANKU\'s influence to refine details coherently.','Stage 1 - OUT03 @ 0.65 JANKU: Prioritize JANKU\'s logic for reconstructing features.','Stage 1 - OUT04 @ 0.70 JANKU: A 70/30 split to ensure details and textures align with JANKU\'s base.','Stage 1 - OUT05 @ 0.75 JANKU: A 3:1 ratio favoring JANKU to ensure clean linework and shading.','Stage 1 - OUT06 @ 0.80 JANKU: Overwhelmingly favor JANKU for fine details like eyes and hair.','Stage 1 - OUT07 @ 0.82 JANKU: Continue strong JANKU bias for final textural polish.','Stage 1 - OUT08 @ 0.85 JANKU: Ensure final composition is coherent and well-structured.','Stage 1 - OUT09 @ 0.88 JANKU: Heavily favor JANKU for high-frequency details and sharpness.','Stage 1 - OUT10 @ 0.90 JANKU: A 90% weight to ensure final linework is crisp and clean for vectorization.','Stage 1 - OUT11 @ 0.92 JANKU: A final decisive weight for JANKU for a clean, artifact-free output.']},
            stage2: { model1: 'Graycolor', model2: 'SinGlo', color1: '#F59E0B', color2: '#78350F', weights: [0.85, 0.85, 0.80, 0.80, 0.75, 0.70, 0.70, 0.65, 0.65, 0.60, 0.60, 0.60, 0.55, 0.60, 0.60, 0.65, 0.65, 0.70, 0.70, 0.75, 0.75, 0.80, 0.80, 0.85, 0.85], justifications: ['Stage 2 (Graycolor/SinGlo) - IN00 @ 0.85 Graycolor: Establish Graycolor\'s semi-realism as the base.','Stage 2 - IN01 @ 0.85 Graycolor: Maintain Graycolor dominance for a consistent painterly foundation.','Stage 2 - IN02 @ 0.80 Graycolor: Start to introduce SinGlo\'s unique textural properties.','Stage 2 - IN03 @ 0.80 Graycolor: Continue blending in SinGlo\'s style.','Stage 2 - IN04 @ 0.75 Graycolor: Increase SinGlo\'s influence on the style.','Stage 2 - IN05 @ 0.70 Graycolor: Give SinGlo a stronger voice in mid-level details.','Stage 2 - IN06 @ 0.70 Graycolor: Give SinGlo a stronger voice in mid-level details.','Stage 2 - IN07 @ 0.65 Graycolor: Move towards a more even blend of textures.','Stage 2 - IN08 @ 0.65 Graycolor: Move towards a more even blend of textures.','Stage 2 - IN09 @ 0.60 Graycolor: Allow SinGlo to significantly influence the pre-middle blocks.','Stage 2 - IN10 @ 0.60 Graycolor: Allow SinGlo to significantly influence the pre-middle blocks.','Stage 1 - IN11 @ 0.60 Graycolor: Allow SinGlo to significantly influence the pre-middle blocks.','Stage 2 - M00 @ 0.55 Graycolor: A near-even split at the core to fuse the two textural styles.','Stage 2 - OUT00 @ 0.60 Graycolor: Start reconstruction with a slight favor to Graycolor\'s coherence.','Stage 2 - OUT01 @ 0.60 Graycolor: Start reconstruction with a slight favor to Graycolor\'s coherence.','Stage 2 - OUT02 @ 0.65 Graycolor: Continue favoring Graycolor for a stable detail base.','Stage 2 - OUT03 @ 0.65 Graycolor: Continue favoring Graycolor for a stable detail base.','Stage 2 - OUT04 @ 0.70 Graycolor: Emphasize Graycolor\'s painterly feel.','Stage 2 - OUT05 @ 0.70 Graycolor: Emphasize Graycolor\'s painterly feel.','Stage 2 - OUT06 @ 0.75 Graycolor: Strongly favor Graycolor for refined textures.','Stage 2 - OUT07 @ 0.75 Graycolor: Strongly favor Graycolor for refined textures.','Stage 2 - OUT08 @ 0.80 Graycolor: Let Graycolor dominate the final detail passes.','Stage 2 - OUT09 @ 0.80 Graycolor: Let Graycolor dominate the final detail passes.','Stage 2 - OUT10 @ 0.85 Graycolor: Overwhelmingly favor Graycolor for a clean, painterly finish.','Stage 2 - OUT11 @ 0.85 Graycolor: Overwhelmingly favor Graycolor for a clean, painterly finish.']},
            stage3: { model1: '"Dark Anime"', model2: '"Painterly Bridge"', color1: '#1E3A8A', color2: '#78350F', weights: [0.90, 0.90, 0.88, 0.85, 0.82, 0.80, 0.78, 0.75, 0.72, 0.70, 0.68, 0.65, 0.60, 0.62, 0.65, 0.68, 0.70, 0.72, 0.75, 0.78, 0.80, 0.82, 0.85, 0.88, 0.90], justifications: ['Stage 3 (Final Fusion) - IN00 @ 0.90 Dark Anime: Overwhelmingly favor the Dark Anime base for structure.','Stage 3 - IN01 @ 0.90 Dark Anime: Maintain structural dominance.','Stage 3 - IN02 @ 0.88 Dark Anime: Gently start introducing the painterly texture.','Stage 3 - IN03 @ 0.85 Dark Anime: Increase the painterly influence slightly.','Stage 3 - IN04 @ 0.82 Dark Anime: Blend more painterly style into the mid-blocks.','Stage 3 - IN05 @ 0.80 Dark Anime: Give the painterly merge a 20% say in style.','Stage 3 - IN06 @ 0.78 Dark Anime: Continue the gradual blend.','Stage 3 - IN07 @ 0.75 Dark Anime: A 75/25 split before the core.','Stage 3 - IN08 @ 0.72 Dark Anime: Further increase painterly influence.','Stage 3 - IN09 @ 0.70 Dark Anime: A 70/30 split.','Stage 3 - IN10 @ 0.68 Dark Anime: Nearing the core, give more weight to the painterly style.','Stage 3 - IN11 @ 0.65 Dark Anime: A strong painterly influence before the bottleneck.','Stage 3 - M00 @ 0.60 Dark Anime: A 60/40 split at the core, favoring the Dark Anime base for thematic coherence but allowing a strong painterly concept.','Stage 3 - OUT00 @ 0.62 Dark Anime: Start reconstruction with a similar 60/40 split.','Stage 3 - OUT01 @ 0.65 Dark Anime: Begin shifting back to the Dark Anime base.','Stage 3 - OUT02 @ 0.68 Dark Anime: Reinforce the core anime style.','Stage 3 - OUT03 @ 0.70 Dark Anime: A 70/30 split to blend details.','Stage 3 - OUT04 @ 0.72 Dark Anime: Prioritize the Dark Anime base\'s detail interpretation.','Stage 3 - OUT05 @ 0.75 Dark Anime: A strong 75/25 split favoring the Dark Anime base for linework.','Stage 3 - OUT06 @ 0.78 Dark Anime: Increase dominance of the base for clean textures.','Stage 3 - OUT07 @ 0.80 Dark Anime: A strong 80/20 split for final details.','Stage 3 - OUT08 @ 0.82 Dark Anime: Further prioritize the base for coherence.','Stage 3 - OUT09 @ 0.85 Dark Anime: Heavily favor the Dark Anime base for sharp, clean lines.','Stage 3 - OUT10 @ 0.88 Dark Anime: Ensure the final output is overwhelmingly defined by the base style.','Stage 3 - OUT11 @ 0.90 Dark Anime: A final decisive weight for the Dark Anime base for a clean, vector-ready finish.']}
        }
    };
    
    const hybridData = {
        labels: blockLabels,
        recipes: {
            stage1: ponyData.recipes.stage1,
            stage2: ponyData.recipes.stage2,
            stage3: { 
                is_dare: true, 
                explanation: `<strong>Stage 3: Anatomical Patch (DARE-TIES)</strong><br>This is the surgical step. We use DARE-TIES to inject only the anatomical knowledge from <strong>Boomer Art</strong> into our 'Dark Anime' base. The goal is a minimal but potent change to fix anatomy without altering the host's style.<br><br><div class="code-block"><strong class="text-amber-300">Node Setup:</strong> \`TIES Merge (DARE)\`
<strong>model_a (Host):</strong> <em>'Dark Anime' Base (from Stage 1)</em>
<strong>model_b (Donor):</strong> Boomer Art Model
<strong>base_model_a:</strong> kohaku-xl-beta5.safetensors
<strong>base_model_b:</strong> sd_xl_base_1.0.safetensors
<strong>dare_setup -></strong> (Connect \`DARE Setup\` node)
<strong>ties_trim_n:</strong> 0.2
<strong>dare_density:</strong> 0.2</div><p class="text-xs text-slate-500 mt-4"><strong>Justification:</strong> A very low \`dare_density\` (0.2) and a tight \`ties_trim_n\` (0.2) ensures an extremely precise and minimal injection. We are transplanting only the most essential anatomical information, leaving the host's style almost completely untouched.</p>`
            },
            stage4: { model1: '"Patched Base"', model2: '"Painterly Bridge"', color1: '#1E3A8A', color2: '#78350F', weights: [0.92,0.90,0.88,0.85,0.82,0.80,0.78,0.75,0.72,0.70,0.68,0.65,0.60,0.62,0.65,0.68,0.70,0.72,0.75,0.78,0.80,0.82,0.85,0.88,0.92], justifications: ['Stage 4 (Final Fusion) - IN00 @ 0.92 Patched Base: Overwhelmingly favor the anatomically-patched Dark Anime base for structure.','Stage 4 - IN01 @ 0.90 Patched Base: Maintain structural dominance.','Stage 4 - IN02 @ 0.88 Patched Base: Gently start introducing the painterly texture.','Stage 4 - IN03 @ 0.85 Patched Base: Increase the painterly influence slightly.','Stage 4 - IN04 @ 0.82 Patched Base: Blend more painterly style into the mid-blocks.','Stage 4 - IN05 @ 0.80 Patched Base: Give the painterly merge a 20% say in style.','Stage 4 - IN06 @ 0.78 Patched Base: Continue the gradual blend.','Stage 4 - IN07 @ 0.75 Patched Base: A 75/25 split before the core.','Stage 4 - IN08 @ 0.72 Patched Base: Further increase painterly influence.','Stage 4 - IN09 @ 0.70 Patched Base: A 70/30 split.','Stage 4 - IN10 @ 0.68 Patched Base: Nearing the core, give more weight to the painterly style.','Stage 4 - IN11 @ 0.65 Patched Base: A strong painterly influence before the bottleneck.','Stage 4 - M00 @ 0.60 Patched Base: A 60/40 split at the core, favoring the Patched Base for thematic coherence but allowing a strong painterly concept.','Stage 4 - OUT00 @ 0.62 Patched Base: Start reconstruction with a similar 60/40 split.','Stage 4 - OUT01 @ 0.65 Patched Base: Begin shifting back to the Patched Base.','Stage 4 - OUT02 @ 0.68 Patched Base: Reinforce the core anime style.','Stage 4 - OUT03 @ 0.70 Patched Base: A 70/30 split to blend details.','Stage 4 - OUT04 @ 0.72 Patched Base: Prioritize the Patched Base\'s detail interpretation.','Stage 4 - OUT05 @ 0.75 Patched Base: A strong 75/25 split favoring the Patched Base for linework.','Stage 4 - OUT06 @ 0.78 Patched Base: Increase dominance of the base for clean textures.','Stage 4 - OUT07 @ 0.80 Patched Base: A strong 80/20 split for final details.','Stage 4 - OUT08 @ 0.82 Patched Base: Further prioritize the base for coherence.','Stage 4 - OUT09 @ 0.85 Patched Base: Heavily favor the Patched Base for sharp, clean lines.','Stage 4 - OUT10 @ 0.88 Patched Base: Ensure the final output is overwhelmingly defined by the base style.','Stage 4 - OUT11 @ 0.92 Patched Base: A final decisive weight for the Patched Base for a clean, vector-ready finish.']}
        }
    };

    let sdxlChartInstance, ponyChartInstance, hybridChartInstance = null;

    const selectSdxlBtn = document.getElementById('select-sdxl');
    const selectPonyBtn = document.getElementById('select-pony');
    const selectHybridBtn = document.getElementById('select-hybrid');
    const sdxlContent = document.getElementById('sdxl-content');
    const ponyContent = document.getElementById('pony-content');
    const hybridContent = document.getElementById('hybrid-content');
    const navBlueprints = document.getElementById('nav-blueprints');
    const navRecipes = document.getElementById('nav-recipes');

    function createChart(ctx, onHoverCallback) {
        return new Chart(ctx, {
            type: 'bar',
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: { duration: 1000 },
                plugins: {
                    tooltip: { 
                        mode: 'index', intersect: false, 
                        callbacks: { label: (c) => `${c.dataset.label}: ${(c.parsed.y * 100).toFixed(2)}%` },
                        backgroundColor: 'rgba(15, 23, 42, 0.8)',
                        titleFont: { weight: 'bold'},
                        bodyFont: { size: 12 },
                        borderColor: '#334155',
                        borderWidth: 1,
                    },
                    legend: { position: 'top', labels: { color: '#cbd5e1' } }
                },
                scales: {
                    x: { stacked: true, grid: { display: false }, ticks: { color: '#94a3b8' } },
                    y: { stacked: true, beginAtZero: true, max: 1.0, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', callback: (v) => (v * 100) + '%' } }
                },
                onHover: onHoverCallback
            }
        });
    }

    function initializeSdxlChart() {
        const ctx = document.getElementById('sdxlChart').getContext('2d');
        const justificationEl = document.getElementById('sdxl-justification');
        const recipeButtons = document.querySelectorAll('#sdxl-content .recipe-btn');
        const explanationEl = document.getElementById('sdxl-recipe-explanation');

        const onHover = (e, el) => {
            const activeBtn = document.querySelector('#sdxl-content .recipe-btn.active');
            if (!activeBtn) return;
            const activeRecipeKey = activeBtn.id.replace('recipe-sdxl-', '');
            justificationEl.textContent = el.length ? sdxlData.recipes[activeRecipeKey].justifications[el[0].index] : 'Hover over a block in the chart to see the justification for its weighting.';
        };
        sdxlChartInstance = createChart(ctx, onHover);

        function updateSdxlChart(recipeKey) {
            const recipe = sdxlData.recipes[recipeKey];
            if (!recipe) return;
            explanationEl.innerHTML = recipe.explanation;
            sdxlChartInstance.data = {
                labels: sdxlData.labels,
                datasets: [
                    { label: 'Animij', data: recipe.weights, backgroundColor: '#4f46e5', barPercentage: 0.9, categoryPercentage: 0.8 },
                    { label: 'Graycolor', data: recipe.weights.map(w => 1 - w), backgroundColor: '#a5b4fc', barPercentage: 0.9, categoryPercentage: 0.8 }
                ]
            };
            sdxlChartInstance.update();
        }
        recipeButtons.forEach(button => button.addEventListener('click', () => {
            const recipeKey = button.id.replace('recipe-sdxl-', '');
            recipeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            updateSdxlChart(recipeKey);
        }));
        updateSdxlChart('balanced');
    }

    function initializePonyChart() {
        const ctx = document.getElementById('ponyChart').getContext('2d');
        const justificationEl = document.getElementById('pony-justification');
        const recipeButtons = document.querySelectorAll('#pony-content .recipe-btn');
        
        const onHover = (e, el) => {
            const activeBtn = document.querySelector('#pony-content .recipe-btn.active');
            if (!activeBtn) return;
            const activeRecipeKey = activeBtn.id.replace('recipe-pony-', '');
            justificationEl.textContent = el.length ? ponyData.recipes[activeRecipeKey].justifications[el[0].index] : 'Select a recipe and hover over a block for justification.';
        };
        ponyChartInstance = createChart(ctx, onHover);

        function updatePonyChart(recipeKey) {
            const recipe = ponyData.recipes[recipeKey];
            if (!recipe) return;
            ponyChartInstance.data = {
                labels: ponyData.labels,
                datasets: [
                    { label: recipe.model1, data: recipe.weights, backgroundColor: recipe.color1, barPercentage: 0.9, categoryPercentage: 0.8 },
                    { label: recipe.model2, data: recipe.weights.map(w => 1 - w), backgroundColor: recipe.color2, barPercentage: 0.9, categoryPercentage: 0.8 }
                ]
            };
            ponyChartInstance.update();
        }
        recipeButtons.forEach(button => button.addEventListener('click', () => {
            const recipeKey = button.id.replace('recipe-pony-', '');
            recipeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            updatePonyChart(recipeKey);
        }));
        updatePonyChart('stage1');
    }
    
    function initializeHybridChart() {
        const ctx = document.getElementById('hybridChart').getContext('2d');
        const justificationEl = document.getElementById('hybrid-justification');
        const recipeButtons = document.querySelectorAll('#hybrid-content .recipe-btn');
        const explanationEl = document.getElementById('hybrid-recipe-explanation');
        const chartContainer = document.querySelector('#hybrid-content .chart-container');

        const onHover = (e, el) => {
            const activeBtn = document.querySelector('#hybrid-content .recipe-btn.active');
            if (!activeBtn) return;
            const activeRecipeKey = activeBtn.id.replace('recipe-hybrid-', '');
            const recipe = hybridData.recipes[activeRecipeKey];
            if (recipe && !recipe.is_dare) {
                justificationEl.textContent = el.length ? recipe.justifications[el[0].index] : 'Select a recipe and hover over a block for justification.';
            } else {
                justificationEl.textContent = 'DARE-TIES settings are fixed and not visualized in the chart.';
            }
        };
        hybridChartInstance = createChart(ctx, onHover);
        
        function updateHybridChart(recipeKey) {
            const recipe = hybridData.recipes[recipeKey];
            if (!recipe) return;
            
            explanationEl.style.display = recipe.explanation ? 'block' : 'none';
            explanationEl.innerHTML = recipe.explanation || '';
            
            if (recipe.is_dare) {
                chartContainer.style.display = 'none';
                justificationEl.textContent = 'DARE-TIES settings are fixed and not visualized in the chart.';
            } else {
                chartContainer.style.display = 'block';
                hybridChartInstance.data = {
                    labels: hybridData.labels,
                    datasets: [
                        { label: recipe.model1, data: recipe.weights, backgroundColor: recipe.color1, barPercentage: 0.9, categoryPercentage: 0.8 },
                        { label: recipe.model2, data: recipe.weights.map(w => 1 - w), backgroundColor: recipe.color2, barPercentage: 0.9, categoryPercentage: 0.8 }
                    ]
                };
                hybridChartInstance.update();
            }
        }
        recipeButtons.forEach(button => button.addEventListener('click', () => {
            const recipeKey = button.id.replace('recipe-hybrid-', '');
            recipeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            updateHybridChart(recipeKey);
        }));
        updateHybridChart('stage1');
    }

    function switchVersion(version) {
        const allContent = [sdxlContent, ponyContent, hybridContent];
        const allButtons = [selectSdxlBtn, selectPonyBtn, selectHybridBtn];
        
        allContent.forEach(el => el.style.display = 'none');
        allButtons.forEach(btn => btn.classList.remove('active'));

        navBlueprints.href = `#${version}-blueprints`;
        navRecipes.href = `#${version}-recipes`;

        if (version === 'sdxl') {
            sdxlContent.style.display = 'block';
            selectSdxlBtn.classList.add('active');
            if (!sdxlChartInstance) initializeSdxlChart();
        } else if (version === 'pony') {
            ponyContent.style.display = 'block';
            selectPonyBtn.classList.add('active');
            if (!ponyChartInstance) initializePonyChart();
        } else if (version === 'hybrid') {
            hybridContent.style.display = 'block';
            selectHybridBtn.classList.add('active');
            if (!hybridChartInstance) initializeHybridChart();
        }
    }

    selectSdxlBtn.addEventListener('click', () => switchVersion('sdxl'));
    selectPonyBtn.addEventListener('click', () => switchVersion('pony'));
    selectHybridBtn.addEventListener('click', () => switchVersion('hybrid'));

    switchVersion('sdxl');
});
    </script>

</body>
</html>
